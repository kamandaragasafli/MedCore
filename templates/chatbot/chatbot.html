{% extends 'base.html' %}
{% load static %}
{% block title %}AI Chatbot - MedAdmin{% endblock %}

{% block active_chatbot %}active{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/chatbot.css' %}">

<div class="page-header">
    <div>
        <div class="page-eyebrow" style="display: flex; align-items: center; gap: 8px;">
            <span style="width: 4px; height: 4px; background: linear-gradient(135deg, #2563eb, #8b5cf6); border-radius: 50%; display: inline-block; animation: pulse 2s infinite;"></span>
            AI Chatbot
        </div>
        <h1 style="background: linear-gradient(135deg, #1e293b 0%, #475569 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
            AI Asistan
        </h1>
        <p>Sualƒ±nƒ±zƒ± yazƒ±n v…ô AI asistanƒ±ndan k√∂m…ôk alƒ±n</p>
    </div>
    <div class="header-actions">
        <button class="ghost-btn" onclick="clearChat()" style="transition: all 0.3s;">
            <i class="fas fa-trash"></i> S√∂hb…ôti T…ômizl…ô
        </button>
    </div>
</div>

<div class="chatbot-container">
    <div class="chatbot-welcome" id="welcomeMessage">
        <div class="welcome-icon">
            <i class="fas fa-robot"></i>
        </div>
        <h2>Salam! üëã</h2>
        <p>M…ôn AI asistanƒ±nƒ±zam. Siz…ô nec…ô k√∂m…ôk ed…ô bil…ôr…ôm?</p>
        <div class="suggested-questions">
            <button class="suggestion-btn" onclick="sendSuggestion('Sistemd…ô nec…ô qeydiyyat …ôlav…ô ed…ô bil…ôr…ôm?')">
                <i class="fas fa-question-circle"></i>
                Sistemd…ô nec…ô qeydiyyat …ôlav…ô ed…ô bil…ôr…ôm?
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('H…ôkim hesabatlarƒ±nƒ± nec…ô g√∂r…ô bil…ôr…ôm?')">
                <i class="fas fa-chart-bar"></i>
                H…ôkim hesabatlarƒ±nƒ± nec…ô g√∂r…ô bil…ôr…ôm?
            </button>
            <button class="suggestion-btn" onclick="sendSuggestion('Abun…ôlik m…ôlumatlarƒ±mƒ± nec…ô yoxlaya bil…ôr…ôm?')">
                <i class="fas fa-info-circle"></i>
                Abun…ôlik m…ôlumatlarƒ±mƒ± nec…ô yoxlaya bil…ôr…ôm?
            </button>
        </div>
    </div>

    <div class="chat-messages" id="chatMessages" style="display: none;">
        <!-- Messages will be added here dynamically -->
    </div>

    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <textarea 
                id="messageInput" 
                class="chat-input" 
                placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n..."
                rows="1"
                onkeydown="handleKeyPress(event)"
            ></textarea>
            <button class="send-button" onclick="sendChatbotMessage()" id="sendButton">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="chat-footer">
            <span class="chat-info">
                <i class="fas fa-shield-alt"></i>
                AI asistanƒ± n8n il…ô inteqrasiya olunub
            </span>
        </div>
    </div>
</div>

<script>
let messageHistory = [];

function handleKeyPress(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendChatbotMessage();
    }
}

function sendSuggestion(text) {
    document.getElementById('messageInput').value = text;
    sendChatbotMessage();
}

function sendChatbotMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Hide welcome message
    document.getElementById('welcomeMessage').style.display = 'none';
    document.getElementById('chatMessages').style.display = 'block';
    
    // Add user message to chat
    addMessage('user', message);
    
    // Clear input
    input.value = '';
    input.style.height = 'auto';
    
    // Disable send button
    const sendButton = document.getElementById('sendButton');
    sendButton.disabled = true;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken') || '{{ csrf_token }}';
    
    // Send to backend
    fetch('{% url "chatbot:send_message" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        credentials: 'same-origin',
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            return response.json().then(err => {
                throw new Error(err.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        hideTypingIndicator();
        if (data.success) {
            addMessage('assistant', data.message);
        } else {
            addMessage('error', data.error || 'X…ôta ba≈ü verdi');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        hideTypingIndicator();
        addMessage('error', 'Baƒülantƒ± x…ôtasƒ±: ' + error.message);
    })
    .finally(() => {
        // Re-enable send button
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    });
}

function addMessage(role, text) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${role}`;
    
    const timestamp = new Date().toLocaleTimeString('az-AZ', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    if (role === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-text">${escapeHtml(text)}</div>
                <div class="message-time">${timestamp}</div>
            </div>
            <div class="message-avatar">
                <i class="fas fa-user"></i>
            </div>
        `;
    } else if (role === 'assistant') {
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <div class="message-text">${escapeHtml(text)}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        `;
    } else if (role === 'error') {
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="message-content">
                <div class="message-text error-text">${escapeHtml(text)}</div>
                <div class="message-time">${timestamp}</div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Add to history
    messageHistory.push({ role, text, timestamp });
}

function clearChat() {
    if (confirm('S√∂hb…ôti t…ômizl…ôm…ôk ist…ôdiyiniz…ô …ôminsiniz?')) {
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('chatMessages').style.display = 'none';
        document.getElementById('welcomeMessage').style.display = 'block';
        messageHistory = [];
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typingIndicator';
    typingDiv.className = 'message message-assistant';
    typingDiv.innerHTML = `
        <div class="message-avatar">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    `;
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

// Auto-resize textarea and setup event listeners
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    }
    
    // Make function globally accessible
    window.sendChatbotMessage = sendChatbotMessage;
});
</script>

{% endblock %}

