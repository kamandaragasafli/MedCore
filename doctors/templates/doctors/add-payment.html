{% extends 'base.html' %}
{% load static %}

{% block title %}MedAdmin - Ödəniş Əlavə Et{% endblock %}

{% block active_add_payment %}active{% endblock %}

{% block content %}
<div class="doctor-content">

    <!-- Mobile Header -->
    <div class="mobile-header">
        <button class="menu-toggle" id="menuToggle">
            <i class="fas fa-bars"></i>
        </button>
        <h1 class="page-title">Ödəniş Əlavə Et</h1>
    </div>

    <!-- Desktop Header -->
    <div class="page-header">
        <h1 class="page-title">Ödəniş Əlavə Et</h1>
    </div>

    <!-- Form Container -->
    <form method="POST" action="{% url 'doctors:add_payment' %}">
        {% csrf_token %}
        
        <div class="form-container">

            <!-- Ödəniş Məlumatlar -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-user"></i>
                    Ödəniş Məlumatlar
                </h3>

                <div class="form-grid">
                    <!-- REGION -->
                    <div class="form-group">
                        <label class="form-label required">Bölgə</label>
                        <select class="form-select" name="region" id="regionSelect" required>
                            <option value="">Seçin</option>
                            {% for region in regions %}
                                <option value="{{ region.id }}">{{ region.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- DOCTOR -->
                    <div class="form-group">
                        <label class="form-label required">Həkim</label>
                        <select class="form-select" name="doctor" id="doctorSelect" required>
                            <option value="">Əvvəl bölgə seçin</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Payment Fields -->
            <div class="form-section">
                <div class="form-grid">

                    <div class="form-group">
                        <label class="form-label required">Ödəniş növü</label>
                        <select class="form-select" name="payment_type" required>
                            <option value="avans">Avans</option>
                            <option value="investisiya">İnvestisiya</option>
                            <option value="geriqaytarma">Geri qaytarma</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Məbləğ</label>
                        <input type="text" class="form-input" name="amount" placeholder="₼" required>
                    </div>

                </div>
            </div>

            <!-- DATE -->
            <div class="form-section">
                <div class="form-grid">
                    <div class="form-group" style="width: 460px;">
                        <label class="form-label">Tarix</label>
                        <input type="date" class="form-input" name="date" value="{{ today|date:'Y-m-d' }}" required>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <a href="#" class="cancel-btn">Ləğv et</a>
                <button type="submit" class="submit-btn">
                    <i class="fas fa-save"></i>
                    Ödəniş Əlavə Et
                </button>
            </div>

        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Bölgə seçiləndə AJAX ilə həkimləri yüklə
    document.getElementById("regionSelect").addEventListener("change", function () {
        const regionId = this.value;
        const doctorSelect = document.getElementById("doctorSelect");

        doctorSelect.innerHTML = `<option value="">Yüklənir...</option>`;

        if (!regionId) {
            doctorSelect.innerHTML = `<option value="">Əvvəl bölgə seçin</option>`;
            return;
        }

        const requestUrl = `/doctors/get-doctors-by-region/?region_id=${encodeURIComponent(regionId)}`;

        fetch(requestUrl, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Server error');
                }
                return response.json();
            })
            .then(data => {
                doctorSelect.innerHTML = `<option value="">Seçin</option>`;
                data.forEach(doctor => {
                    doctorSelect.innerHTML += `<option value="${doctor.id}">${doctor.name}</option>`;
                });
            })
            .catch(() => {
                doctorSelect.innerHTML = `<option value="">Xəta baş verdi</option>`;
            });
    });
</script>
{% endblock %}
