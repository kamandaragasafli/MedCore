{% extends 'master_admin/base.html' %}

{% block title %}{{ company.name }} - Ətraflı{% endblock %}

{% block content %}
<div class="page-header" style="margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="color: var(--master-primary); margin-bottom: 10px;">
                <i class="fas fa-building"></i> {{ company.name }}
            </h1>
            <p style="color: #666;">Şirkət Ətraflı Məlumat</p>
        </div>
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'master_admin:send_notification' company.id %}" class="btn-master" style="text-decoration: none; background: #f59e0b;">
                <i class="fas fa-bell"></i> Bildiriş Göndər
            </a>
            <a href="{% url 'master_admin:switch_to_company' company.id %}" class="btn-master" style="text-decoration: none;">
                <i class="fas fa-sign-in-alt"></i> Bu Şirkətə Daxil Ol
            </a>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
    <!-- Company Info -->
    <div class="master-card">
        <h3 style="color: var(--master-primary); margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i> Ümumi Məlumat
        </h3>
        
        <table style="width: 100%;">
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Şirkət Adı:</td>
                <td style="padding: 10px 0;">{{ company.name }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Email:</td>
                <td style="padding: 10px 0;">{{ company.email }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Telefon:</td>
                <td style="padding: 10px 0;">{{ company.phone|default:"N/A" }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Ünvan:</td>
                <td style="padding: 10px 0;">{{ company.address|default:"N/A" }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Qeydiyyat Tarixi:</td>
                <td style="padding: 10px 0;">{{ company.created_at|date:"d M Y, H:i" }}</td>
            </tr>
            <tr>
                <td style="padding: 10px 0; font-weight: 600; color: #666;">Database:</td>
                <td style="padding: 10px 0;"><code>{{ company.db_name|default:"N/A" }}</code></td>
            </tr>
        </table>
        
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e5e7eb;">
            <a href="/admin/subscription/company/{{ company.id }}/change/" class="btn-master" target="_blank" style="text-decoration: none;">
                <i class="fas fa-edit"></i> Django Admin'də Redaktə Et
            </a>
        </div>
    </div>
    
    <!-- Current Subscription -->
    <div class="master-card">
        <h3 style="color: var(--master-primary); margin-bottom: 20px;">
            <i class="fas fa-star"></i> Cari Abunəlik
        </h3>
        
        {% if active_subscription %}
        <div style="background: {% if active_subscription.status == 'active' %}#dcfce7{% else %}#fee2e2{% endif %}; padding: 20px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0;">{{ active_subscription.plan.name }}</h4>
                <span class="status-badge {{ active_subscription.status }}">
                    {{ active_subscription.get_status_display }}
                </span>
            </div>
            
            <div style="margin: 10px 0;">
                <div style="font-size: 24px; font-weight: bold; color: #1f2937;">
                    {{ active_subscription.plan.price }} ₼
                </div>
                <div style="font-size: 13px; color: #666;">
                    {{ active_subscription.plan.duration_days }} günlük paket
                </div>
            </div>
            
            <div style="margin: 15px 0; padding: 15px 0; border-top: 1px solid rgba(0,0,0,0.1); border-bottom: 1px solid rgba(0,0,0,0.1);">
                <div style="font-size: 13px; margin-bottom: 8px;">
                    <strong>Başlama:</strong> {{ active_subscription.start_date|date:"d M Y" }}
                </div>
                <div style="font-size: 13px; margin-bottom: 8px;">
                    <strong>Bitmə:</strong> {{ active_subscription.end_date|date:"d M Y" }}
                </div>
                <div style="font-size: 13px;">
                    <strong>Qalan Müddət:</strong> {{ active_subscription.days_remaining }} gün
                </div>
            </div>
            
            <div style="margin-top: 15px;">
                <strong>Özelliklər:</strong>
                <ul style="margin-top: 10px; padding-left: 20px;">
                    <li>Max İstifadəçi: {{ active_subscription.plan.max_users|default:"Limitsiz" }}</li>
                    <li>Max Həkim: {{ active_subscription.plan.max_doctors|default:"Limitsiz" }}</li>
                    <li>Max Xəstə: {{ active_subscription.plan.max_patients|default:"Limitsiz" }}</li>
                </ul>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: #fef2f2; border-radius: 8px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #dc2626; margin-bottom: 15px;"></i>
            <p style="color: #dc2626; font-weight: 600;">Aktiv abunəlik yoxdur</p>
            <p style="font-size: 13px; color: #666; margin-top: 10px;">Bu şirkətin aktiv abunəliyi yoxdur.</p>
        </div>
        {% endif %}
    </div>
</div>

{% if tenant_db_error %}
<!-- Tenant Database Error -->
<div class="master-card" style="margin-bottom: 20px; background: #fef2f2; border-left: 4px solid #dc2626;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc2626;"></i>
        <div>
            <h4 style="color: #dc2626; margin: 0 0 5px 0;">Verilənlər Bazası Xətası</h4>
            <p style="color: #991b1b; margin: 0;">{{ tenant_db_error }}</p>
            <p style="color: #666; margin: 10px 0 0 0; font-size: 13px;">
                Bu şirkət üçün verilənlər bazası məlumatlarını görmək üçün migrasiyaları icra edin:
                <code style="background: #fee2e2; padding: 2px 6px; border-radius: 3px;">python manage.py migrate --database={{ company.db_name }}</code>
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 20px;">
    <div class="master-card" style="text-align: center;">
        <div style="font-size: 32px; color: var(--master-primary); margin-bottom: 10px;">
            <i class="fas fa-user-md"></i>
        </div>
        <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">
            {{ doctors_count|default:0 }}
        </div>
        <div style="color: #666; font-size: 14px;">Ümumi Həkim</div>
        <div style="color: #22c55e; font-size: 12px; margin-top: 5px;">
            {{ active_doctors_count|default:0 }} aktiv
        </div>
    </div>
    
    <div class="master-card" style="text-align: center;">
        <div style="font-size: 32px; color: #dc2626; margin-bottom: 10px;">
            <i class="fas fa-money-bill-wave"></i>
        </div>
        <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">
            {{ total_debt|floatformat:2|default:"0.00" }} ₼
        </div>
        <div style="color: #666; font-size: 14px;">Ümumi Borc</div>
    </div>
    
    <div class="master-card" style="text-align: center;">
        <div style="font-size: 32px; color: #10b981; margin-bottom: 10px;">
            <i class="fas fa-pills"></i>
        </div>
        <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">
            {{ drugs_count|default:0 }}
        </div>
        <div style="color: #666; font-size: 14px;">Aktiv Dərman</div>
    </div>
    
    <div class="master-card" style="text-align: center;">
        <div style="font-size: 32px; color: #6366f1; margin-bottom: 10px;">
            <i class="fas fa-users"></i>
        </div>
        <div style="font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 5px;">
            {{ user_count }}
        </div>
        <div style="color: #666; font-size: 14px;">İstifadəçi</div>
    </div>
</div>

<!-- Doctors Section -->
<div class="master-card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--master-primary); margin: 0;">
            <i class="fas fa-user-md"></i> Həkimlər ({{ doctors_count|default:0 }})
        </h3>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'master_admin:export_company_doctors' company.id %}" 
               class="btn-master" 
               style="text-decoration: none; background: #10b981; padding: 8px 16px; font-size: 14px;">
                <i class="fas fa-file-excel"></i> Excel-ə Yüklə
            </a>
            <a href="{% url 'master_admin:import_company_debts' company.id %}" 
               class="btn-master" 
               style="text-decoration: none; background: #f97316; padding: 8px 16px; font-size: 14px;">
                <i class="fas fa-upload"></i> Borcu Import et
            </a>
        </div>
    </div>
    
    {% if doctors %}
    <div style="max-height: 400px; overflow-y: auto;">
        <table class="table-master">
            <thead>
                <tr>
                    <th>Kod</th>
                    <th>Ad Soyad</th>
                    <th>İxtisas</th>
                    <th>Bölgə</th>
                    <th>Klinika</th>
                    <th>Telefon</th>
                    <th>Yekun Borc</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for doctor in doctors %}
                <tr>
                    <td><strong>{{ doctor.code }}</strong></td>
                    <td>{{ doctor.ad }}</td>
                    <td>{{ doctor.ixtisas.name|default:"-" }}</td>
                    <td>{{ doctor.region.name|default:"-" }}</td>
                    <td>{{ doctor.clinic.name|default:"-" }}</td>
                    <td>{{ doctor.telefon|default:"-" }}</td>
                    <td style="font-weight: bold; color: {% if doctor.yekun_borc > 0 %}#dc2626{% elif doctor.yekun_borc < 0 %}#22c55e{% else %}#666{% endif %};">
                        {{ doctor.yekun_borc|floatformat:2 }} ₼
                    </td>
                    <td>
                        {% if doctor.is_active %}
                            <span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Aktiv</span>
                        {% else %}
                            <span style="color: #dc2626;"><i class="fas fa-times-circle"></i> Deaktiv</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if doctors_count > 50 %}
    <p style="text-align: center; color: #999; margin-top: 15px; font-size: 13px;">
        Yalnız son 50 həkim göstərilir. Bütün həkimləri görmək üçün Excel faylını yükləyin.
    </p>
    {% endif %}
    {% else %}
    <p style="text-align: center; color: #999; padding: 20px;">Həkim yoxdur</p>
    {% endif %}
</div>

<!-- Financial Summary -->
<div class="master-card" style="margin-bottom: 20px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="color: var(--master-primary); margin: 0;">
            <i class="fas fa-chart-line"></i> Maliyyə Xülasəsi
        </h3>
        <div style="display: flex; gap: 10px;">
            <a href="{% url 'master_admin:export_company_debts' company.id %}" 
               class="btn-master" 
               style="text-decoration: none; background: #dc2626; padding: 8px 16px; font-size: 14px;">
                <i class="fas fa-file-excel"></i> Borclar Excel-ə
            </a>
        </div>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        <div style="background: #fef3c7; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Ümumi Borc</div>
            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">
                {{ total_debt|floatformat:2|default:"0.00" }} ₼
            </div>
        </div>
        
        <div style="background: #dbeafe; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Aktiv Həkim</div>
            <div style="font-size: 28px; font-weight: bold; color: #1e40af;">
                {{ active_doctors_count|default:0 }}
            </div>
        </div>
        
        <div style="background: #dcfce7; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 18px; color: #666; margin-bottom: 10px;">Ümumi Həkim</div>
            <div style="font-size: 28px; font-weight: bold; color: #166534;">
                {{ doctors_count|default:0 }}
            </div>
        </div>
    </div>
</div>

<!-- Medications Section -->
<div class="master-card" style="margin-bottom: 20px;">
    <h3 style="color: var(--master-primary); margin-bottom: 20px;">
        <i class="fas fa-pills"></i> Dərmanlar ({{ drugs_count|default:0 }})
    </h3>
    
    <div style="margin-bottom: 15px; display: flex; justify-content: flex-end; gap: 10px;">
        <a href="{% url 'master_admin:import_company_drugs' company.id %}"
           class="btn-master"
           style="text-decoration: none; background: #0ea5e9; padding: 6px 14px; font-size: 13px;">
            <i class="fas fa-upload"></i> Dərmanları Import et
        </a>
    </div>

    {% if drugs %}
    <div style="max-height: 300px; overflow-y: auto;">
        <table class="table-master">
            <thead>
                <tr>
                    <th>Ad</th>
                    <th>Tam Ad</th>
                    <th>Buraxılış Forması</th>
                    <th>Qiymət</th>
                    <th>Komissiya</th>
                    <th>Dozaj</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for drug in drugs %}
                <tr>
                    <td><strong>{{ drug.ad }}</strong></td>
                    <td>{{ drug.tam_ad|default:"-" }}</td>
                    <td>{{ drug.get_buraxilis_formasi_display }}</td>
                    <td style="font-weight: bold;">{{ drug.qiymet|floatformat:2 }} ₼</td>
                    <td>{{ drug.komissiya|floatformat:2 }} ₼</td>
                    <td>{{ drug.dozaj|default:"-" }}</td>
                    <td>
                        {% if drug.is_active %}
                            <span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Aktiv</span>
                        {% else %}
                            <span style="color: #dc2626;"><i class="fas fa-times-circle"></i> Deaktiv</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% if drugs_count > 50 %}
    <p style="text-align: center; color: #999; margin-top: 15px; font-size: 13px;">
        Yalnız ilk 50 dərman göstərilir.
    </p>
    {% endif %}
    {% else %}
    <p style="text-align: center; color: #999; padding: 20px;">Dərman yoxdur</p>
    {% endif %}
</div>

<!-- Users -->
<div class="master-card" style="margin-bottom: 20px;">
    <h3 style="color: var(--master-primary); margin-bottom: 20px;">
        <i class="fas fa-users"></i> İstifadəçilər ({{ user_count }})
    </h3>
    
    {% if users %}
    <table class="table-master">
        <thead>
            <tr>
                <th>İstifadəçi Adı</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Status</th>
                <th>Qeydiyyat Tarixi</th>
            </tr>
        </thead>
        <tbody>
            {% for profile in users %}
            <tr>
                <td>
                    <strong>{{ profile.user.get_full_name|default:profile.user.username }}</strong>
                </td>
                <td>{{ profile.user.email }}</td>
                <td>
                    <span style="padding: 4px 8px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 12px;">
                        {{ profile.get_role_display }}
                    </span>
                </td>
                <td>
                    {% if profile.is_active %}
                        <span style="color: #22c55e;"><i class="fas fa-check-circle"></i> Aktiv</span>
                    {% else %}
                        <span style="color: #dc2626;"><i class="fas fa-times-circle"></i> Deaktiv</span>
                    {% endif %}
                </td>
                <td>{{ profile.created_at|date:"d M Y" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: #999; padding: 20px;">İstifadəçi yoxdur</p>
    {% endif %}
</div>

<!-- Subscription History -->
<div class="master-card">
    <h3 style="color: var(--master-primary); margin-bottom: 20px;">
        <i class="fas fa-history"></i> Abunəlik Tarixçəsi
    </h3>
    
    {% if subscriptions %}
    <div style="position: relative; padding-left: 30px;">
        {% for sub in subscriptions %}
        <div style="position: relative; padding: 15px; margin-bottom: 15px; border-left: 3px solid {% if sub.status == 'active' %}#22c55e{% elif sub.status == 'expired' %}#dc2626{% else %}#6b7280{% endif %}; background: #f9fafb; border-radius: 8px;">
            <div style="position: absolute; left: -8px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: {% if sub.status == 'active' %}#22c55e{% elif sub.status == 'expired' %}#dc2626{% else %}#6b7280{% endif %};"></div>
            
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                    <div style="font-weight: 600; font-size: 16px; margin-bottom: 5px;">
                        {{ sub.plan.name }}
                        <span class="status-badge {{ sub.status }}" style="margin-left: 10px;">
                            {{ sub.get_status_display }}
                        </span>
                    </div>
                    <div style="font-size: 13px; color: #666;">
                        <i class="fas fa-calendar"></i> {{ sub.start_date|date:"d M Y" }} - {{ sub.end_date|date:"d M Y" }}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 18px; font-weight: bold; color: #1f2937;">
                        {{ sub.plan.price }} ₼
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center; color: #999; padding: 20px;">Abunəlik tarixçəsi yoxdur</p>
    {% endif %}
</div>

<!-- Back Button -->
<div style="margin-top: 30px; text-align: center;">
    <a href="{% url 'master_admin:company_list' %}" class="btn-master" style="text-decoration: none;">
        <i class="fas fa-arrow-left"></i> Şirkətlər Siyahısına Qayıt
    </a>
</div>
{% endblock %}

